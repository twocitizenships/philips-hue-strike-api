{"ast":null,"code":"\"use strict\";\n\nfunction _slicedToArray(arr, i) {\n  return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest();\n}\n\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n}\n\nfunction _iterableToArrayLimit(arr, i) {\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n  var _e = undefined;\n\n  try {\n    for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n\n  return _arr;\n}\n\nfunction _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {\n  try {\n    var info = gen[key](arg);\n    var value = info.value;\n  } catch (error) {\n    reject(error);\n    return;\n  }\n\n  if (info.done) {\n    resolve(value);\n  } else {\n    Promise.resolve(value).then(_next, _throw);\n  }\n}\n\nfunction _asyncToGenerator(fn) {\n  return function () {\n    var self = this,\n        args = arguments;\n    return new Promise(function (resolve, reject) {\n      var gen = fn.apply(self, args);\n\n      function _next(value) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value);\n      }\n\n      function _throw(err) {\n        asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err);\n      }\n\n      _next(undefined);\n    });\n  };\n}\n\nvar Events, IORedisConnection, Scripts, parser;\nparser = require(\"./parser\");\nEvents = require(\"./Events\");\nScripts = require(\"./Scripts\");\n\nIORedisConnection = function () {\n  class IORedisConnection {\n    constructor() {\n      let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      parser.load(options, this.defaults, this);\n\n      if (this.Redis == null) {\n        this.Redis = eval(\"require\")(\"ioredis\"); // Obfuscated or else Webpack/Angular will try to inline the optional ioredis module. To override this behavior: pass the ioredis module to Bottleneck as the 'Redis' option.\n      }\n\n      if (this.Events == null) {\n        this.Events = new Events(this);\n      }\n\n      this.terminated = false;\n\n      if (this.clusterNodes != null) {\n        this.client = new this.Redis.Cluster(this.clusterNodes, this.clientOptions);\n        this.subscriber = new this.Redis.Cluster(this.clusterNodes, this.clientOptions);\n      } else if (this.client != null && this.client.duplicate == null) {\n        this.subscriber = new this.Redis.Cluster(this.client.startupNodes, this.client.options);\n      } else {\n        if (this.client == null) {\n          this.client = new this.Redis(this.clientOptions);\n        }\n\n        this.subscriber = this.client.duplicate();\n      }\n\n      this.limiters = {};\n      this.ready = this.Promise.all([this._setup(this.client, false), this._setup(this.subscriber, true)]).then(() => {\n        this._loadScripts();\n\n        return {\n          client: this.client,\n          subscriber: this.subscriber\n        };\n      });\n    }\n\n    _setup(client, sub) {\n      client.setMaxListeners(0);\n      return new this.Promise((resolve, reject) => {\n        client.on(\"error\", e => {\n          return this.Events.trigger(\"error\", e);\n        });\n\n        if (sub) {\n          client.on(\"message\", (channel, message) => {\n            var ref;\n            return (ref = this.limiters[channel]) != null ? ref._store.onMessage(channel, message) : void 0;\n          });\n        }\n\n        if (client.status === \"ready\") {\n          return resolve();\n        } else {\n          return client.once(\"ready\", resolve);\n        }\n      });\n    }\n\n    _loadScripts() {\n      return Scripts.names.forEach(name => {\n        return this.client.defineCommand(name, {\n          lua: Scripts.payload(name)\n        });\n      });\n    }\n\n    __runCommand__(cmd) {\n      var _this = this;\n\n      return _asyncToGenerator(function* () {\n        var _, deleted;\n\n        yield _this.ready;\n\n        var _ref = yield _this.client.pipeline([cmd]).exec();\n\n        var _ref2 = _slicedToArray(_ref, 1);\n\n        var _ref2$ = _slicedToArray(_ref2[0], 2);\n\n        _ = _ref2$[0];\n        deleted = _ref2$[1];\n        return deleted;\n      })();\n    }\n\n    __addLimiter__(instance) {\n      return this.Promise.all([instance.channel(), instance.channel_client()].map(channel => {\n        return new this.Promise((resolve, reject) => {\n          return this.subscriber.subscribe(channel, () => {\n            this.limiters[channel] = instance;\n            return resolve();\n          });\n        });\n      }));\n    }\n\n    __removeLimiter__(instance) {\n      var _this2 = this;\n\n      return [instance.channel(), instance.channel_client()].forEach( /*#__PURE__*/function () {\n        var _ref3 = _asyncToGenerator(function* (channel) {\n          if (!_this2.terminated) {\n            yield _this2.subscriber.unsubscribe(channel);\n          }\n\n          return delete _this2.limiters[channel];\n        });\n\n        return function (_x) {\n          return _ref3.apply(this, arguments);\n        };\n      }());\n    }\n\n    __scriptArgs__(name, id, args, cb) {\n      var keys;\n      keys = Scripts.keys(name, id);\n      return [keys.length].concat(keys, args, cb);\n    }\n\n    __scriptFn__(name) {\n      return this.client[name].bind(this.client);\n    }\n\n    disconnect() {\n      let flush = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n      var i, k, len, ref;\n      ref = Object.keys(this.limiters);\n\n      for (i = 0, len = ref.length; i < len; i++) {\n        k = ref[i];\n        clearInterval(this.limiters[k]._store.heartbeat);\n      }\n\n      this.limiters = {};\n      this.terminated = true;\n\n      if (flush) {\n        return this.Promise.all([this.client.quit(), this.subscriber.quit()]);\n      } else {\n        this.client.disconnect();\n        this.subscriber.disconnect();\n        return this.Promise.resolve();\n      }\n    }\n\n  }\n\n  ;\n  IORedisConnection.prototype.datastore = \"ioredis\";\n  IORedisConnection.prototype.defaults = {\n    Redis: null,\n    clientOptions: {},\n    clusterNodes: null,\n    client: null,\n    Promise: Promise,\n    Events: null\n  };\n  return IORedisConnection;\n}.call(void 0);\n\nmodule.exports = IORedisConnection;","map":{"version":3,"sources":["/Users/clusk/Documents/OtherRepositories/StrikeElectric/node_modules/bottleneck/lib/IORedisConnection.js"],"names":["_slicedToArray","arr","i","_arrayWithHoles","_iterableToArrayLimit","_nonIterableRest","TypeError","_arr","_n","_d","_e","undefined","_i","Symbol","iterator","_s","next","done","push","value","length","err","Array","isArray","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","error","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","Events","IORedisConnection","Scripts","parser","require","constructor","options","load","defaults","Redis","eval","terminated","clusterNodes","client","Cluster","clientOptions","subscriber","duplicate","startupNodes","limiters","ready","all","_setup","_loadScripts","sub","setMaxListeners","on","e","trigger","channel","message","ref","_store","onMessage","status","once","names","forEach","name","defineCommand","lua","payload","__runCommand__","cmd","_this","_","deleted","_ref","pipeline","exec","_ref2","_ref2$","__addLimiter__","instance","channel_client","map","subscribe","__removeLimiter__","_this2","_ref3","unsubscribe","_x","__scriptArgs__","id","cb","keys","concat","__scriptFn__","bind","disconnect","flush","k","len","Object","clearInterval","heartbeat","quit","prototype","datastore","call","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nfunction _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }\n\nfunction _nonIterableRest() { throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); }\n\nfunction _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i[\"return\"] != null) _i[\"return\"](); } finally { if (_d) throw _e; } } return _arr; }\n\nfunction _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }\n\nfunction _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err); } _next(undefined); }); }; }\n\nvar Events, IORedisConnection, Scripts, parser;\nparser = require(\"./parser\");\nEvents = require(\"./Events\");\nScripts = require(\"./Scripts\");\n\nIORedisConnection = function () {\n  class IORedisConnection {\n    constructor(options = {}) {\n      parser.load(options, this.defaults, this);\n\n      if (this.Redis == null) {\n        this.Redis = eval(\"require\")(\"ioredis\"); // Obfuscated or else Webpack/Angular will try to inline the optional ioredis module. To override this behavior: pass the ioredis module to Bottleneck as the 'Redis' option.\n      }\n\n      if (this.Events == null) {\n        this.Events = new Events(this);\n      }\n\n      this.terminated = false;\n\n      if (this.clusterNodes != null) {\n        this.client = new this.Redis.Cluster(this.clusterNodes, this.clientOptions);\n        this.subscriber = new this.Redis.Cluster(this.clusterNodes, this.clientOptions);\n      } else if (this.client != null && this.client.duplicate == null) {\n        this.subscriber = new this.Redis.Cluster(this.client.startupNodes, this.client.options);\n      } else {\n        if (this.client == null) {\n          this.client = new this.Redis(this.clientOptions);\n        }\n\n        this.subscriber = this.client.duplicate();\n      }\n\n      this.limiters = {};\n      this.ready = this.Promise.all([this._setup(this.client, false), this._setup(this.subscriber, true)]).then(() => {\n        this._loadScripts();\n\n        return {\n          client: this.client,\n          subscriber: this.subscriber\n        };\n      });\n    }\n\n    _setup(client, sub) {\n      client.setMaxListeners(0);\n      return new this.Promise((resolve, reject) => {\n        client.on(\"error\", e => {\n          return this.Events.trigger(\"error\", e);\n        });\n\n        if (sub) {\n          client.on(\"message\", (channel, message) => {\n            var ref;\n            return (ref = this.limiters[channel]) != null ? ref._store.onMessage(channel, message) : void 0;\n          });\n        }\n\n        if (client.status === \"ready\") {\n          return resolve();\n        } else {\n          return client.once(\"ready\", resolve);\n        }\n      });\n    }\n\n    _loadScripts() {\n      return Scripts.names.forEach(name => {\n        return this.client.defineCommand(name, {\n          lua: Scripts.payload(name)\n        });\n      });\n    }\n\n    __runCommand__(cmd) {\n      var _this = this;\n\n      return _asyncToGenerator(function* () {\n        var _, deleted;\n\n        yield _this.ready;\n\n        var _ref = yield _this.client.pipeline([cmd]).exec();\n\n        var _ref2 = _slicedToArray(_ref, 1);\n\n        var _ref2$ = _slicedToArray(_ref2[0], 2);\n\n        _ = _ref2$[0];\n        deleted = _ref2$[1];\n        return deleted;\n      })();\n    }\n\n    __addLimiter__(instance) {\n      return this.Promise.all([instance.channel(), instance.channel_client()].map(channel => {\n        return new this.Promise((resolve, reject) => {\n          return this.subscriber.subscribe(channel, () => {\n            this.limiters[channel] = instance;\n            return resolve();\n          });\n        });\n      }));\n    }\n\n    __removeLimiter__(instance) {\n      var _this2 = this;\n\n      return [instance.channel(), instance.channel_client()].forEach(\n      /*#__PURE__*/\n      function () {\n        var _ref3 = _asyncToGenerator(function* (channel) {\n          if (!_this2.terminated) {\n            yield _this2.subscriber.unsubscribe(channel);\n          }\n\n          return delete _this2.limiters[channel];\n        });\n\n        return function (_x) {\n          return _ref3.apply(this, arguments);\n        };\n      }());\n    }\n\n    __scriptArgs__(name, id, args, cb) {\n      var keys;\n      keys = Scripts.keys(name, id);\n      return [keys.length].concat(keys, args, cb);\n    }\n\n    __scriptFn__(name) {\n      return this.client[name].bind(this.client);\n    }\n\n    disconnect(flush = true) {\n      var i, k, len, ref;\n      ref = Object.keys(this.limiters);\n\n      for (i = 0, len = ref.length; i < len; i++) {\n        k = ref[i];\n        clearInterval(this.limiters[k]._store.heartbeat);\n      }\n\n      this.limiters = {};\n      this.terminated = true;\n\n      if (flush) {\n        return this.Promise.all([this.client.quit(), this.subscriber.quit()]);\n      } else {\n        this.client.disconnect();\n        this.subscriber.disconnect();\n        return this.Promise.resolve();\n      }\n    }\n\n  }\n\n  ;\n  IORedisConnection.prototype.datastore = \"ioredis\";\n  IORedisConnection.prototype.defaults = {\n    Redis: null,\n    clientOptions: {},\n    clusterNodes: null,\n    client: null,\n    Promise: Promise,\n    Events: null\n  };\n  return IORedisConnection;\n}.call(void 0);\n\nmodule.exports = IORedisConnection;"]},"metadata":{},"sourceType":"script"}