{"ast":null,"code":"import { HTTPError } from '../errors/HTTPError.js';\nimport { TimeoutError } from '../errors/TimeoutError.js';\nimport { deepMerge, mergeHeaders } from '../utils/merge.js';\nimport { normalizeRequestMethod, normalizeRetryOptions } from '../utils/normalize.js';\nimport { delay, timeout } from '../utils/time.js';\nimport { maxSafeTimeout, responseTypes, stop, supportsAbortController, supportsFormData, supportsStreams } from './constants.js';\nexport class Ky {\n  // eslint-disable-next-line complexity\n  constructor(input) {\n    let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    var _a, _b;\n\n    this._retryCount = 0;\n    this._input = input;\n    this._options = {\n      // TODO: credentials can be removed when the spec change is implemented in all browsers. Context: https://www.chromestatus.com/feature/4539473312350208\n      credentials: this._input.credentials || 'same-origin',\n      ...options,\n      headers: mergeHeaders(this._input.headers, options.headers),\n      hooks: deepMerge({\n        beforeRequest: [],\n        beforeRetry: [],\n        afterResponse: []\n      }, options.hooks),\n      method: normalizeRequestMethod((_a = options.method) !== null && _a !== void 0 ? _a : this._input.method),\n      // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n      prefixUrl: String(options.prefixUrl || ''),\n      retry: normalizeRetryOptions(options.retry),\n      throwHttpErrors: options.throwHttpErrors !== false,\n      timeout: typeof options.timeout === 'undefined' ? 10000 : options.timeout,\n      fetch: (_b = options.fetch) !== null && _b !== void 0 ? _b : globalThis.fetch.bind(globalThis)\n    };\n\n    if (typeof this._input !== 'string' && !(this._input instanceof URL || this._input instanceof globalThis.Request)) {\n      throw new TypeError('`input` must be a string, URL, or Request');\n    }\n\n    if (this._options.prefixUrl && typeof this._input === 'string') {\n      if (this._input.startsWith('/')) {\n        throw new Error('`input` must not begin with a slash when using `prefixUrl`');\n      }\n\n      if (!this._options.prefixUrl.endsWith('/')) {\n        this._options.prefixUrl += '/';\n      }\n\n      this._input = this._options.prefixUrl + this._input;\n    }\n\n    if (supportsAbortController) {\n      this.abortController = new globalThis.AbortController();\n\n      if (this._options.signal) {\n        this._options.signal.addEventListener('abort', () => {\n          this.abortController.abort();\n        });\n      }\n\n      this._options.signal = this.abortController.signal;\n    }\n\n    this.request = new globalThis.Request(this._input, this._options);\n\n    if (this._options.searchParams) {\n      // eslint-disable-next-line unicorn/prevent-abbreviations\n      const textSearchParams = typeof this._options.searchParams === 'string' ? this._options.searchParams.replace(/^\\?/, '') : new URLSearchParams(this._options.searchParams).toString(); // eslint-disable-next-line unicorn/prevent-abbreviations\n\n      const searchParams = '?' + textSearchParams;\n      const url = this.request.url.replace(/(?:\\?.*?)?(?=#|$)/, searchParams); // To provide correct form boundary, Content-Type header should be deleted each time when new Request instantiated from another one\n\n      if ((supportsFormData && this._options.body instanceof globalThis.FormData || this._options.body instanceof URLSearchParams) && !(this._options.headers && this._options.headers['content-type'])) {\n        this.request.headers.delete('content-type');\n      }\n\n      this.request = new globalThis.Request(new globalThis.Request(url, this.request), this._options);\n    }\n\n    if (this._options.json !== undefined) {\n      this._options.body = JSON.stringify(this._options.json);\n      this.request.headers.set('content-type', 'application/json');\n      this.request = new globalThis.Request(this.request, {\n        body: this._options.body\n      });\n    }\n  } // eslint-disable-next-line @typescript-eslint/promise-function-async\n\n\n  static create(input, options) {\n    const ky = new Ky(input, options);\n\n    const fn = async () => {\n      if (ky._options.timeout > maxSafeTimeout) {\n        throw new RangeError(`The \\`timeout\\` option cannot be greater than ${maxSafeTimeout}`);\n      } // Delay the fetch so that body method shortcuts can set the Accept header\n\n\n      await Promise.resolve();\n      let response = await ky._fetch();\n\n      for (const hook of ky._options.hooks.afterResponse) {\n        // eslint-disable-next-line no-await-in-loop\n        const modifiedResponse = await hook(ky.request, ky._options, ky._decorateResponse(response.clone()));\n\n        if (modifiedResponse instanceof globalThis.Response) {\n          response = modifiedResponse;\n        }\n      }\n\n      ky._decorateResponse(response);\n\n      if (!response.ok && ky._options.throwHttpErrors) {\n        throw new HTTPError(response, ky.request, ky._options);\n      } // If `onDownloadProgress` is passed, it uses the stream API internally\n\n      /* istanbul ignore next */\n\n\n      if (ky._options.onDownloadProgress) {\n        if (typeof ky._options.onDownloadProgress !== 'function') {\n          throw new TypeError('The `onDownloadProgress` option must be a function');\n        }\n\n        if (!supportsStreams) {\n          throw new Error('Streams are not supported in your environment. `ReadableStream` is missing.');\n        }\n\n        return ky._stream(response.clone(), ky._options.onDownloadProgress);\n      }\n\n      return response;\n    };\n\n    const isRetriableMethod = ky._options.retry.methods.includes(ky.request.method.toLowerCase());\n\n    const result = isRetriableMethod ? ky._retry(fn) : fn();\n\n    for (const [type, mimeType] of Object.entries(responseTypes)) {\n      result[type] = async () => {\n        // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n        ky.request.headers.set('accept', ky.request.headers.get('accept') || mimeType);\n        const response = (await result).clone();\n\n        if (type === 'json') {\n          if (response.status === 204) {\n            return '';\n          }\n\n          if (options.parseJson) {\n            return options.parseJson(await response.text());\n          }\n        }\n\n        return response[type]();\n      };\n    }\n\n    return result;\n  }\n\n  _calculateRetryDelay(error) {\n    this._retryCount++;\n\n    if (this._retryCount < this._options.retry.limit && !(error instanceof TimeoutError)) {\n      if (error instanceof HTTPError) {\n        if (!this._options.retry.statusCodes.includes(error.response.status)) {\n          return 0;\n        }\n\n        const retryAfter = error.response.headers.get('Retry-After');\n\n        if (retryAfter && this._options.retry.afterStatusCodes.includes(error.response.status)) {\n          let after = Number(retryAfter);\n\n          if (Number.isNaN(after)) {\n            after = Date.parse(retryAfter) - Date.now();\n          } else {\n            after *= 1000;\n          }\n\n          if (typeof this._options.retry.maxRetryAfter !== 'undefined' && after > this._options.retry.maxRetryAfter) {\n            return 0;\n          }\n\n          return after;\n        }\n\n        if (error.response.status === 413) {\n          return 0;\n        }\n      }\n\n      const BACKOFF_FACTOR = 0.3;\n      return BACKOFF_FACTOR * 2 ** (this._retryCount - 1) * 1000;\n    }\n\n    return 0;\n  }\n\n  _decorateResponse(response) {\n    if (this._options.parseJson) {\n      response.json = async () => this._options.parseJson(await response.text());\n    }\n\n    return response;\n  }\n\n  async _retry(fn) {\n    try {\n      return await fn(); // eslint-disable-next-line @typescript-eslint/no-implicit-any-catch\n    } catch (error) {\n      const ms = Math.min(this._calculateRetryDelay(error), maxSafeTimeout);\n\n      if (ms !== 0 && this._retryCount > 0) {\n        await delay(ms);\n\n        for (const hook of this._options.hooks.beforeRetry) {\n          // eslint-disable-next-line no-await-in-loop\n          const hookResult = await hook({\n            request: this.request,\n            options: this._options,\n            error: error,\n            retryCount: this._retryCount\n          }); // If `stop` is returned from the hook, the retry process is stopped\n\n          if (hookResult === stop) {\n            return;\n          }\n        }\n\n        return this._retry(fn);\n      }\n\n      throw error;\n    }\n  }\n\n  async _fetch() {\n    for (const hook of this._options.hooks.beforeRequest) {\n      // eslint-disable-next-line no-await-in-loop\n      const result = await hook(this.request, this._options);\n\n      if (result instanceof Request) {\n        this.request = result;\n        break;\n      }\n\n      if (result instanceof Response) {\n        return result;\n      }\n    }\n\n    if (this._options.timeout === false) {\n      return this._options.fetch(this.request.clone());\n    }\n\n    return timeout(this.request.clone(), this.abortController, this._options);\n  }\n  /* istanbul ignore next */\n\n\n  _stream(response, onDownloadProgress) {\n    const totalBytes = Number(response.headers.get('content-length')) || 0;\n    let transferredBytes = 0;\n    return new globalThis.Response(new globalThis.ReadableStream({\n      async start(controller) {\n        const reader = response.body.getReader();\n\n        if (onDownloadProgress) {\n          onDownloadProgress({\n            percent: 0,\n            transferredBytes: 0,\n            totalBytes\n          }, new Uint8Array());\n        }\n\n        async function read() {\n          const {\n            done,\n            value\n          } = await reader.read();\n\n          if (done) {\n            controller.close();\n            return;\n          }\n\n          if (onDownloadProgress) {\n            transferredBytes += value.byteLength;\n            const percent = totalBytes === 0 ? 0 : transferredBytes / totalBytes;\n            onDownloadProgress({\n              percent,\n              transferredBytes,\n              totalBytes\n            }, value);\n          }\n\n          controller.enqueue(value);\n          await read();\n        }\n\n        await read();\n      }\n\n    }));\n  }\n\n}","map":{"version":3,"sources":["/Users/clusk/Documents/OtherRepositories/strike-tipping-widget/node_modules/ky/source/core/Ky.ts"],"names":[],"mappings":"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","sourcesContent":["import {HTTPError} from '../errors/HTTPError.js';\nimport {TimeoutError} from '../errors/TimeoutError.js';\nimport type {Hooks} from '../types/hooks.js';\nimport type {Input, InternalOptions, NormalizedOptions, Options, SearchParamsInit} from '../types/options.js';\nimport {ResponsePromise} from '../types/response.js';\nimport {deepMerge, mergeHeaders} from '../utils/merge.js';\nimport {normalizeRequestMethod, normalizeRetryOptions} from '../utils/normalize.js';\nimport {delay, timeout, TimeoutOptions} from '../utils/time.js';\nimport {ObjectEntries} from '../utils/types.js';\nimport {maxSafeTimeout, responseTypes, stop, supportsAbortController, supportsFormData, supportsStreams} from './constants.js';\n\nexport class Ky {\n\t// eslint-disable-next-line @typescript-eslint/promise-function-async\n\tstatic create(input: Input, options: Options): ResponsePromise {\n\t\tconst ky = new Ky(input, options);\n\n\t\tconst fn = async (): Promise<Response> => {\n\t\t\tif (ky._options.timeout > maxSafeTimeout) {\n\t\t\t\tthrow new RangeError(`The \\`timeout\\` option cannot be greater than ${maxSafeTimeout}`);\n\t\t\t}\n\n\t\t\t// Delay the fetch so that body method shortcuts can set the Accept header\n\t\t\tawait Promise.resolve();\n\t\t\tlet response = await ky._fetch();\n\n\t\t\tfor (const hook of ky._options.hooks.afterResponse) {\n\t\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\t\tconst modifiedResponse = await hook(\n\t\t\t\t\tky.request,\n\t\t\t\t\tky._options as NormalizedOptions,\n\t\t\t\t\tky._decorateResponse(response.clone()),\n\t\t\t\t);\n\n\t\t\t\tif (modifiedResponse instanceof globalThis.Response) {\n\t\t\t\t\tresponse = modifiedResponse;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tky._decorateResponse(response);\n\n\t\t\tif (!response.ok && ky._options.throwHttpErrors) {\n\t\t\t\tthrow new HTTPError(response, ky.request, (ky._options as unknown) as NormalizedOptions);\n\t\t\t}\n\n\t\t\t// If `onDownloadProgress` is passed, it uses the stream API internally\n\t\t\t/* istanbul ignore next */\n\t\t\tif (ky._options.onDownloadProgress) {\n\t\t\t\tif (typeof ky._options.onDownloadProgress !== 'function') {\n\t\t\t\t\tthrow new TypeError('The `onDownloadProgress` option must be a function');\n\t\t\t\t}\n\n\t\t\t\tif (!supportsStreams) {\n\t\t\t\t\tthrow new Error('Streams are not supported in your environment. `ReadableStream` is missing.');\n\t\t\t\t}\n\n\t\t\t\treturn ky._stream(response.clone(), ky._options.onDownloadProgress);\n\t\t\t}\n\n\t\t\treturn response;\n\t\t};\n\n\t\tconst isRetriableMethod = ky._options.retry.methods.includes(ky.request.method.toLowerCase());\n\t\tconst result = (isRetriableMethod ? ky._retry(fn) : fn()) as ResponsePromise;\n\n\t\tfor (const [type, mimeType] of Object.entries(responseTypes) as ObjectEntries<typeof responseTypes>) {\n\t\t\tresult[type] = async () => {\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n\t\t\t\tky.request.headers.set('accept', ky.request.headers.get('accept') || mimeType);\n\n\t\t\t\tconst response = (await result).clone();\n\n\t\t\t\tif (type === 'json') {\n\t\t\t\t\tif (response.status === 204) {\n\t\t\t\t\t\treturn '';\n\t\t\t\t\t}\n\n\t\t\t\t\tif (options.parseJson) {\n\t\t\t\t\t\treturn options.parseJson(await response.text());\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn response[type]();\n\t\t\t};\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tpublic request: Request;\n\tprotected abortController?: AbortController;\n\tprotected _retryCount = 0;\n\tprotected _input: Input;\n\tprotected _options: InternalOptions;\n\n\t// eslint-disable-next-line complexity\n\tconstructor(input: Input, options: Options = {}) {\n\t\tthis._input = input;\n\t\tthis._options = {\n\t\t\t// TODO: credentials can be removed when the spec change is implemented in all browsers. Context: https://www.chromestatus.com/feature/4539473312350208\n\t\t\tcredentials: (this._input as Request).credentials || 'same-origin',\n\t\t\t...options,\n\t\t\theaders: mergeHeaders((this._input as Request).headers, options.headers),\n\t\t\thooks: deepMerge<Required<Hooks>>(\n\t\t\t\t{\n\t\t\t\t\tbeforeRequest: [],\n\t\t\t\t\tbeforeRetry: [],\n\t\t\t\t\tafterResponse: [],\n\t\t\t\t},\n\t\t\t\toptions.hooks,\n\t\t\t),\n\t\t\tmethod: normalizeRequestMethod(options.method ?? (this._input as Request).method),\n\t\t\t// eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n\t\t\tprefixUrl: String(options.prefixUrl || ''),\n\t\t\tretry: normalizeRetryOptions(options.retry),\n\t\t\tthrowHttpErrors: options.throwHttpErrors !== false,\n\t\t\ttimeout: typeof options.timeout === 'undefined' ? 10_000 : options.timeout,\n\t\t\tfetch: options.fetch ?? globalThis.fetch.bind(globalThis),\n\t\t};\n\n\t\tif (typeof this._input !== 'string' && !(this._input instanceof URL || this._input instanceof globalThis.Request)) {\n\t\t\tthrow new TypeError('`input` must be a string, URL, or Request');\n\t\t}\n\n\t\tif (this._options.prefixUrl && typeof this._input === 'string') {\n\t\t\tif (this._input.startsWith('/')) {\n\t\t\t\tthrow new Error('`input` must not begin with a slash when using `prefixUrl`');\n\t\t\t}\n\n\t\t\tif (!this._options.prefixUrl.endsWith('/')) {\n\t\t\t\tthis._options.prefixUrl += '/';\n\t\t\t}\n\n\t\t\tthis._input = this._options.prefixUrl + this._input;\n\t\t}\n\n\t\tif (supportsAbortController) {\n\t\t\tthis.abortController = new globalThis.AbortController();\n\t\t\tif (this._options.signal) {\n\t\t\t\tthis._options.signal.addEventListener('abort', () => {\n\t\t\t\t\tthis.abortController!.abort();\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis._options.signal = this.abortController.signal;\n\t\t}\n\n\t\tthis.request = new globalThis.Request(this._input as RequestInfo, this._options as RequestInit);\n\n\t\tif (this._options.searchParams) {\n\t\t\t// eslint-disable-next-line unicorn/prevent-abbreviations\n\t\t\tconst textSearchParams = typeof this._options.searchParams === 'string'\n\t\t\t\t? this._options.searchParams.replace(/^\\?/, '')\n\t\t\t\t: new URLSearchParams(this._options.searchParams as unknown as SearchParamsInit).toString();\n\t\t\t// eslint-disable-next-line unicorn/prevent-abbreviations\n\t\t\tconst searchParams = '?' + textSearchParams;\n\t\t\tconst url = this.request.url.replace(/(?:\\?.*?)?(?=#|$)/, searchParams);\n\n\t\t\t// To provide correct form boundary, Content-Type header should be deleted each time when new Request instantiated from another one\n\t\t\tif (\n\t\t\t\t((supportsFormData && this._options.body instanceof globalThis.FormData)\n\t\t\t\t|| this._options.body instanceof URLSearchParams) && !(this._options.headers && (this._options.headers as Record<string, string>)['content-type'])\n\t\t\t) {\n\t\t\t\tthis.request.headers.delete('content-type');\n\t\t\t}\n\n\t\t\tthis.request = new globalThis.Request(new globalThis.Request(url, this.request), this._options as RequestInit);\n\t\t}\n\n\t\tif (this._options.json !== undefined) {\n\t\t\tthis._options.body = JSON.stringify(this._options.json);\n\t\t\tthis.request.headers.set('content-type', 'application/json');\n\t\t\tthis.request = new globalThis.Request(this.request, {body: this._options.body});\n\t\t}\n\t}\n\n\tprotected _calculateRetryDelay(error: unknown) {\n\t\tthis._retryCount++;\n\n\t\tif (this._retryCount < this._options.retry.limit && !(error instanceof TimeoutError)) {\n\t\t\tif (error instanceof HTTPError) {\n\t\t\t\tif (!this._options.retry.statusCodes.includes(error.response.status)) {\n\t\t\t\t\treturn 0;\n\t\t\t\t}\n\n\t\t\t\tconst retryAfter = error.response.headers.get('Retry-After');\n\t\t\t\tif (retryAfter && this._options.retry.afterStatusCodes.includes(error.response.status)) {\n\t\t\t\t\tlet after = Number(retryAfter);\n\t\t\t\t\tif (Number.isNaN(after)) {\n\t\t\t\t\t\tafter = Date.parse(retryAfter) - Date.now();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tafter *= 1000;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof this._options.retry.maxRetryAfter !== 'undefined' && after > this._options.retry.maxRetryAfter) {\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn after;\n\t\t\t\t}\n\n\t\t\t\tif (error.response.status === 413) {\n\t\t\t\t\treturn 0;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst BACKOFF_FACTOR = 0.3;\n\t\t\treturn BACKOFF_FACTOR * (2 ** (this._retryCount - 1)) * 1000;\n\t\t}\n\n\t\treturn 0;\n\t}\n\n\tprotected _decorateResponse(response: Response): Response {\n\t\tif (this._options.parseJson) {\n\t\t\tresponse.json = async () => this._options.parseJson!(await response.text());\n\t\t}\n\n\t\treturn response;\n\t}\n\n\tprotected async _retry<T extends (...args: any) => Promise<any>>(fn: T): Promise<ReturnType<T> | void> {\n\t\ttry {\n\t\t\treturn await fn();\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-implicit-any-catch\n\t\t} catch (error) {\n\t\t\tconst ms = Math.min(this._calculateRetryDelay(error), maxSafeTimeout);\n\t\t\tif (ms !== 0 && this._retryCount > 0) {\n\t\t\t\tawait delay(ms);\n\n\t\t\t\tfor (const hook of this._options.hooks.beforeRetry) {\n\t\t\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\t\t\tconst hookResult = await hook({\n\t\t\t\t\t\trequest: this.request,\n\t\t\t\t\t\toptions: (this._options as unknown) as NormalizedOptions,\n\t\t\t\t\t\terror: error as Error,\n\t\t\t\t\t\tretryCount: this._retryCount,\n\t\t\t\t\t});\n\n\t\t\t\t\t// If `stop` is returned from the hook, the retry process is stopped\n\t\t\t\t\tif (hookResult === stop) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn this._retry(fn);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprotected async _fetch(): Promise<Response> {\n\t\tfor (const hook of this._options.hooks.beforeRequest) {\n\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\tconst result = await hook(this.request, (this._options as unknown) as NormalizedOptions);\n\n\t\t\tif (result instanceof Request) {\n\t\t\t\tthis.request = result;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (result instanceof Response) {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\n\t\tif (this._options.timeout === false) {\n\t\t\treturn this._options.fetch(this.request.clone());\n\t\t}\n\n\t\treturn timeout(this.request.clone(), this.abortController, this._options as TimeoutOptions);\n\t}\n\n\t/* istanbul ignore next */\n\tprotected _stream(response: Response, onDownloadProgress: Options['onDownloadProgress']) {\n\t\tconst totalBytes = Number(response.headers.get('content-length')) || 0;\n\t\tlet transferredBytes = 0;\n\n\t\treturn new globalThis.Response(\n\t\t\tnew globalThis.ReadableStream({\n\t\t\t\tasync start(controller) {\n\t\t\t\t\tconst reader = response.body!.getReader();\n\n\t\t\t\t\tif (onDownloadProgress) {\n\t\t\t\t\t\tonDownloadProgress({percent: 0, transferredBytes: 0, totalBytes}, new Uint8Array());\n\t\t\t\t\t}\n\n\t\t\t\t\tasync function read() {\n\t\t\t\t\t\tconst {done, value} = await reader.read();\n\t\t\t\t\t\tif (done) {\n\t\t\t\t\t\t\tcontroller.close();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (onDownloadProgress) {\n\t\t\t\t\t\t\ttransferredBytes += value!.byteLength;\n\t\t\t\t\t\t\tconst percent = totalBytes === 0 ? 0 : transferredBytes / totalBytes;\n\t\t\t\t\t\t\tonDownloadProgress({percent, transferredBytes, totalBytes}, value!);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tcontroller.enqueue(value!);\n\t\t\t\t\t\tawait read();\n\t\t\t\t\t}\n\n\t\t\t\t\tawait read();\n\t\t\t\t},\n\t\t\t}),\n\t\t);\n\t}\n}\n"]},"metadata":{},"sourceType":"module"}